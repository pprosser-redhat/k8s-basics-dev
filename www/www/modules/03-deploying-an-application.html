<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploying an Application :: Kubernetes Basic Workshop</title>
    <link rel="canonical" href="https://github.com/pprosser-redhat/k8s-basics-dev.git/modules/03-deploying-an-application.html">
    <meta name="generator" content="Antora 3.1.12">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
  </head>
  <body class="article">
<header class="header" role="banner">

</header>
<div class="main-wrapper">

  <main class="main">
<div class="toolbar" role="navigation">
</div><article class="doc">
<h1>Deploying an Application</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Now you have checked your access to the Kubernetes cluster is working, we are going to immediately jump in and deploy a complete application, consisting of a front end web application, a backend restful application, along with a MongoDB database for storing the worlds national parks in. Together, they will implement a site that maps the worlds national parks.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_an_application"><a class="anchor" href="#_deploying_an_application"></a>Deploying an Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is to show you how quickly you can deploy a complete application to Kubernetes if you already have the configuration. Once the complete application has been deployed, we will delete the front end web application component, and deploy it again in steps so you can see how it fits together and how it uses Kubernetes.</p>
</div>
<div class="sect2">
<h3 id="_deploying_the_database"><a class="anchor" href="#_deploying_the_database"></a>Deploying the database</h3>
<div class="paragraph">
<p>The first part of the application we want to deploy is the MongoDB database. The set of resource files for deploying this can be found in the <code>database</code> directory.</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ls -las database/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each file in the directory contains a different resource definition which go together to make up the deployment for the application component.</p>
</div>
<div class="paragraph">
<p>Rather than try and dig into each file to work out what it defines, you can have Kubernetes tell you what resources it would create when the directory of resources is processed. To do this, run:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">kubectl apply -f database/ --dry-run=client</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">secret/blog-credentials created (dry run)
service/blog-db created (dry run)
persistentvolumeclaim/blog-database created (dry run)
deployment.apps/blog-db created (dry run)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>kubectl apply</code> command in this case is what is used to create resources from a configuration file, or set of files contained in a directory. We used the <code>--dry-run=client</code> option, which says to tell us what would be created, but don&#8217;t actually do it. The <code>--dry-run=client</code> option is useful because it will tell you what resources would be created, but also validates the resource definitions and will warn you if you have errors in them.</p>
</div>
<div class="paragraph">
<p>If you are ever uncertain about what a command does, or what options it accepts, you can run it with the <code>--help</code> option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl apply --help</code></pre>
</div>
</div>
<div class="paragraph">
<p>By doing a dry run deployment, you have seen the resources that will be created. To actually deploy the database component, now run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl apply -f database/</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the dry run, <code>kubectl apply</code> will list the resources, except this time the resources will be created.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">secret/blog-credentials created
service/blog-db created
persistentvolumeclaim/blog-database created
deployment.apps/blog-db created</code></pre>
</div>
</div>
<div class="paragraph">
<p>The key resource in this list is <code>deployment</code>. It specifies the name of the container image to be deployed for an application, how many instances should be started, and the strategy for how the deployment should be managed.</p>
</div>
<div class="paragraph">
<p>To monitor progress of the deployment, and know when it has completed, you can run the command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl rollout  status deployment/mongodb-community-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>The argument is the full name of the resource, including the type of resource and the name for this instance. In this case the instance was called <code>mongodb-community-server</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_the_front_end_web_application"><a class="anchor" href="#_deploying_the_front_end_web_application"></a>Deploying the front end web application</h3>
<div class="paragraph">
<p>With the database deployed, now deploy the front end web application by running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl apply -f frontend/</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">deployment.apps/parksmap created
ingress.networking.k8s.io/parksmap created
rolebinding.rbac.authorization.k8s.io/parksmap-view created
service/parksmap created</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl rollout status deployment/parksmap</code></pre>
</div>
</div>
<div class="paragraph">
<p>to monitor and wait for it to be deployed.</p>
</div>
<div class="paragraph">
<p>In the resources created for the front end web application, the <code>ingress</code> is special, in that it is what sets up access to our web application using a public URL.</p>
</div>
<div class="paragraph">
<p>In this example, the URL for accessing the front end web application will be:</p>
</div>
<div class="paragraph">
<p>You need to substitute the <code>PROJECT_NAMESPACE</code> and <code>CLUSTER_SUBDOMAIN</code> variables with your own values.</p>
</div>
<div class="paragraph">
<p><a href="http://parksmap-%project_namespace%.%cluster_subdomain%" class="bare">http://parksmap-%project_namespace%.%cluster_subdomain%</a></p>
</div>
<div class="paragraph">
<p>This is easy to findout by running a query againts the parksmap ingress using <code>kubectl</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl get ingress parksmap -o=jsonpath='{.spec.rules[0]}' | jq</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should output something like this:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{
  "host": "parksmap-user1-workshop.apps.cluster-5cbfd.dynamic.redhatworkshops.io",
  "http": {
    "paths": [
      {
        "backend": {
          "service": {
            "name": "parksmap",
            "port": {
              "number": 8080
            }
          }
        },
        "path": "/",
        "pathType": "Prefix"
      }
    ]
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The value of host is what you are after.</p>
</div>
<div class="paragraph">
<p>Visit the front end web application by typing (or copying).</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">http://parksmap-user1-workshop.apps.cluster-5cbfd.dynamic.redhatworkshops.io</code></pre>
</div>
</div>
<div class="paragraph">
<p>into your browser (<code>Please make sure you use the host name from your cluster</code>)</p>
</div>
<div class="paragraph">
<p>It should look like:</p>
</div>
<div class="imageblock bordershadow">
<div class="content">
<a class="image" href="_images/parksmap.png" target="_blank" rel="noopener"><img src="_images/parksmap.png" alt="parksmap"></a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are no national parks displayed as yet. We still have to deploy the backend application, which is what we&#8217;ll do next.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_the_backend_restful_application"><a class="anchor" href="#_deploy_the_backend_restful_application"></a>Deploy the backend restful application</h3>
<div class="paragraph">
<p>With the front end web application deployed, now deploy the backend application by running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl apply -f ./backend/</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">deployment.apps/nationalparks-py created
ingress.networking.k8s.io/nationalparks-py created
service/nationalparks-py created</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl rollout status deployment/nationalparks-py</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now visit the front end web application again (make sure you refresh the page), and you&#8217;ll notice that there are still no national parks displayed. This is because there is no data in the database yet.</p>
</div>
</div>
<div class="sect2">
<h3 id="_load_the_data"><a class="anchor" href="#_load_the_data"></a>Load the data</h3>
<div class="paragraph">
<p>Fortunately, the backend application has an API that we can use to load the data. Later, we&#8217;ll look at how logging might have helped us work this out.</p>
</div>
<div class="paragraph">
<p>To load the data into the database, run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">curl http://nationalparks-py:8080/ws/data/load</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">"Items inserted in database: 2762"</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the terminal window is running in the same namespace as the nationalparks-py application on Kubernetes, it can access the kubernetes service directly hence no need for finding out the ingress host name to use (more later).</p>
</div>
</div>
<div class="sect2">
<h3 id="_let_the_fun_begin"><a class="anchor" href="#_let_the_fun_begin"></a>Let the fun begin!!!</h3>
<div class="paragraph">
<p>You should now see a page similar to the one below:</p>
</div>
<div class="paragraph">
<p>Refresh the parksmap page in the <code>browser</code> and this time you should see national parks appearing on the map.</p>
</div>
<div class="imageblock bordershadow">
<div class="content">
<a class="image" href="_images/parksmap-with-np.png" target="_blank" rel="noopener"><img src="_images/parksmap-with-np.png" alt="parksmap with np"></a>
</div>
</div>
<div class="paragraph">
<p>Feel free to move around the map, zoom in and out, and click on national parks.</p>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer role="contentinfo">
  <div class="region region-rhd-footer">
    <div id="block-rhdfooter" class="rhd-footer">
      <nav class="rhd-footer-nav" aria-label="Secondary Navigation" role="navigation">
  <ul class="rhd-menu">
    
  </ul>
</nav>
    </div>
  </div>
</footer>
<script src="../_/js/site.js"></script>
<script src="../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>
