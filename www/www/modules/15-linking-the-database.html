<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untitled :: Kubernetes Basic Workshop</title>
    <link rel="canonical" href="https://github.com/pprosser-redhat/k8s-basics-dev.git/modules/15-linking-the-database.html">
    <meta name="generator" content="Antora 3.1.12">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
  </head>
  <body class="article">
<header class="header" role="banner">

</header>
<div class="main-wrapper">

  <main class="main">
<div class="toolbar" role="navigation">
</div><article class="doc">
<div class="paragraph">
<p>The front end web application is running and is accessible to the public internet. At this point it is using a file based SQLite database which has been pre-populated with some posts. This database is local to each instance, not shared between all (making it unsuited to a scaled application), and any changes to data will be lost whenever the <code>pod</code> restarts.</p>
</div>
<div class="paragraph">
<p>To provide persistence for data, and have all instances of the application using the same database, we will configure the front end web application to use the separate Postgresql database which is already running.</p>
</div>
<div class="paragraph">
<p>To view the resources for the database, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl get deployment,service,pvc,secret -l app=blog-db -o name</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should yield:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">deployment.extensions/blog-db
service/blog-db
persistentvolumeclaim/blog-database
secret/blog-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should understand now the purpose of <code>deployment</code> and <code>service</code>. The <code>persistentvolumeclaim</code> is used to claim persistent storage for use by the database. The <code>secret</code> is used to hold the credentials for the database.</p>
</div>
<div class="paragraph">
<p>In order to link the database to the front end web application, we need to tell the front end web application the name of the host for the database, and what the login credentials are. To do this we need to add environment variable settings to the <code>deployment</code> for the front end web application.</p>
</div>
<div class="paragraph">
<p>You can see what environment variables are already set for the front end web application by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl set env deployment/blog --list</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should display:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># Deployment blog, container blog
BLOG_SITE_NAME=OpenShift Blog</code></pre>
</div>
</div>
<div class="paragraph">
<p>The way that the front end web application is implemented, it is expecting the following environment variables for a separate database.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DATABASE_HOST</code> - The host name of the database.</p>
</li>
<li>
<p><code>DATABASE_USER</code> - The user to login into the database.</p>
</li>
<li>
<p><code>DATABASE_PASSWORD</code> - The password of the user for the database.</p>
</li>
<li>
<p><code>DATABASE_NAME</code> - The name of the database.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To set environment variables, <code>kubectl</code> provides the command <code>kubectl set env</code>. We don&#8217;t want to update the live configuration, but keep the configuration locally, but we can use it to work out the changes we need to make to that configuration.</p>
</div>
<div class="paragraph">
<p>For the database host, the host name will be the name of the database <code>service</code> object, which is <code>blog-db</code>.</p>
</div>
<div class="paragraph">
<p>To see what the <code>deployment</code> configuration would look like with that set, we can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl set env deployment/blog DATABASE_HOST=blog-db --dry-run -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the output, you can see that along side the existing <code>BLOG_SITE_NAME</code> environment variable, you now have the <code>DATABASE_HOST</code> environment variable. This is under the <code>spec.template.spec.containers.env</code> setting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    spec:
      containers:
      - env:
        - name: BLOG_SITE_NAME
          value: OpenShift Blog
        - name: DATABASE_HOST
          value: blog-db</code></pre>
</div>
</div>
<div class="paragraph">
<p>The database credentials could be added in a similar way, but for this application we already have those stored in the <code>secret</code> for the database. You can view the <code>secret</code> called <code>blog-credentials</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl get secret/blog-credentials -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the output you will see the <code>data</code> section holding values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">data:
  database-name: YmxvZw==
  database-password: dG9wLXNlY3JldA==
  database-user: YmxvZw==</code></pre>
</div>
</div>
<div class="paragraph">
<p>What you see aren&#8217;t the actual values as they have been obfuscated using base64 encoding.</p>
</div>
<div class="paragraph">
<p>In order to use the same values, but not actually have to copy them, you can configure the <code>deployment</code> to inject the environment variables from the secret. To see how the configuration should look for this you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl set env deployment/blog --from secret/blog-credentials --dry-run -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>For these, the <code>spec.template.spec.containers.env</code> setting would need to be updated to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    spec:
      containers:
      - env:
        - name: BLOG_SITE_NAME
          value: OpenShift Blog
        - name: DATABASE_NAME
          valueFrom:
            secretKeyRef:
              key: database-name
              name: blog-credentials
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: database-password
              name: blog-credentials
        - name: DATABASE_USER
          valueFrom:
            secretKeyRef:
              key: database-user
              name: blog-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>Combining all of these we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">cat frontend-v4/deployment.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>To apply this configuration run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-execute hljs" data-lang="execute">kubectl apply -f frontend-v4/</code></pre>
</div>
</div>
<div class="paragraph">
<p>The database and the front end web application are now linked, but some extra steps are required to initalise the database.</p>
</div>
</article>
  </main>
</div>
<footer role="contentinfo">
  <div class="region region-rhd-footer">
    <div id="block-rhdfooter" class="rhd-footer">
      <nav class="rhd-footer-nav" aria-label="Secondary Navigation" role="navigation">
  <ul class="rhd-menu">
    
  </ul>
</nav>
    </div>
  </div>
</footer>
<script src="../_/js/site.js"></script>
<script src="../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>
